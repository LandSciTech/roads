<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using the grade penalty function • roads</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using the grade penalty function">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">roads</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/grade-penalty.html">Using the grade penalty function</a></li>
    <li><a class="dropdown-item" href="../articles/ReconstructRoadHistory.html">Reconstruct road development history</a></li>
    <li><a class="dropdown-item" href="../articles/roads-vignette.html">roads Package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/LandSciTech/roads/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using the grade penalty function</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LandSciTech/roads/blob/master/vignettes/grade-penalty.Rmd" class="external-link"><code>vignettes/grade-penalty.Rmd</code></a></small>
      <div class="d-none name"><code>grade-penalty.Rmd</code></div>
    </div>

    
    
<p>In this tutorial we explore the <code>gradePenaltyFn</code> by
attempting to build roads to randomly selected locations in a
mountainous region of British Columbia, Canada. While the elevation and
landcover data used is real, the roads and landings are not and
projected roads are not expected to match observed roads. In most real
applications, an established existing road network will constrain the
locations of new access roads. <code>gradePenaltyFn</code> uses a
simplified version of the grade penalty approach taken by Anderson and
Nelson (2004) to penalize roads that go up steep slopes and encourage
roads to follow the contours of the landscape.</p>
<p>To use the grade penalty function we need to supply a raster to the
<code>weightRaster</code> argument that contains elevation and has other
barriers (eg water bodies) included in the raster as negative or
<code>NA</code> values. In this example we will use an elevation and
proportion water data set downloaded with the <code>geodata</code>
package and cropped to an example area in British Columbia, Canada that
is included in the package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/LandSciTech/roads" class="external-link">roads</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.8.93</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:terra':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, union</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span></span>
<span><span class="co"># prep the terra rasters for use</span></span>
<span><span class="va">dem_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepExData.html">prepExData</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">)</span></span></code></pre></div>
<p>The elevation data shows that this is a mountainous region.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">$</span><span class="va">ex_elev</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/elev-1.png" class="r-plt" alt="" width="624"></p>
<p>And the proportion of the landscape covered by water in each cell
shows that there are several long narrow lakes crossing the
landscape.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">$</span><span class="va">ex_wat</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/water-1.png" class="r-plt" alt="" width="624"></p>
<p><code>gradePenaltyFn</code> requires a single raster as input but
allows factors other than grade that will affect road construction to be
included in the raster as negative values and barriers where no road
construction is possible to be included as <code>NA</code> values. In
this example we will assume that road construction is impossible for
cells where the proportion of water is &gt; 50%. Then we set areas with
less than 1% water to NA so that the grade penalty will still apply in
this case. We also need to get the penalty for water crossing on to a
similar scale as the grade penalty in this case we will assume the same
base cost of $16178 and the same penalty of $504 for every percentage
point increase in percent water. Note this is just an example and there
are certainly better data sources for the locations and costs of stream
crossings.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set water to NA when a cell is &gt; 50% water</span></span>
<span><span class="va">wat_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">$</span><span class="va">ex_wat</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set elev to NA when water is NA</span></span>
<span><span class="va">elev_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">$</span><span class="va">ex_elev</span>, <span class="va">wat_use</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now change water to NA when it is &lt; 1% water</span></span>
<span><span class="va">wat_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">wat_use</span>, <span class="va">wat_use</span> <span class="op">&lt;</span> <span class="fl">0.01</span>, maskvalue <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wat_use</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">wat_use</span> <span class="op">*</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">504</span> <span class="op">-</span> <span class="fl">16178</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wat_use</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" alt="" width="624"></p>
<p>We then combine the two rasters together by setting elevation to 0
when there is a water penalty and summing them.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set elev to 0 when wat is NA</span></span>
<span><span class="va">elev_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">elev_use</span>, <span class="va">wat_use</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span>, updatevalue <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add wat_use to elev when not NA</span></span>
<span><span class="va">wt_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">elev_use</span>, <span class="va">wat_use</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wt_rast</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span>, <span class="cn">NA</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="624"></p>
<p>Next we randomly select points to serve as landings (i.e. locations
to build roads to). We limit the landings to being at less than 2000m
elevation and less than 1% water and then randomly select points. We use
a stratified sample below since this is the easiest way to get a sample
of just the cells that are <code>TRUE</code> in
<code>for_area</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get landing points</span></span>
<span></span>
<span><span class="va">for_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wat_use</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">elev_use</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">elev_use</span> <span class="op">&lt;</span> <span class="fl">2000</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">for_area</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"forest"</span></span>
<span></span>
<span><span class="co"># set seed to make repeatable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1235</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lnds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sample.html" class="external-link">spatSample</a></span><span class="op">(</span><span class="va">for_area</span>, <span class="fl">20</span>, method <span class="op">=</span> <span class="st">"stratified"</span>, as.points <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   ext <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">for_area</span><span class="op">)</span><span class="op">-</span><span class="fl">0.001</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">forest</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wt_rast</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lnds</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in plot.sf(lnds, add = TRUE, col = "red"): ignoring all but the first</span></span>
<span><span class="co">#&gt; attribute</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" alt="" width="624"></p>
<p>Finally, we create an initial road to serve as a starting point. This
can be done interactively using <code><a href="https://rspatial.github.io/terra/reference/draw.html" class="external-link">terra::draw</a></code> but we saved
the result using <code>dput</code> to make it re-runnable.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get starting road</span></span>
<span></span>
<span><span class="co"># create line interactively</span></span>
<span><span class="co"># line &lt;- draw("line")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># line &lt;- st_as_sf(line)</span></span>
<span></span>
<span><span class="co"># get line non-interactively</span></span>
<span><span class="va">rd_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  geometry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">118.103238840217</span>, <span class="op">-</span><span class="fl">118.103238840217</span>, <span class="op">-</span><span class="fl">118.112765313949</span>, <span class="op">-</span><span class="fl">118.115940805193</span>, </span>
<span>                <span class="op">-</span><span class="fl">118.115940805193</span>, <span class="op">-</span><span class="fl">118.106414331461</span>, <span class="op">-</span><span class="fl">118.106414331461</span>, <span class="op">-</span><span class="fl">118.100063348973</span>,</span>
<span>                <span class="op">-</span><span class="fl">118.077834910265</span>, <span class="op">-</span><span class="fl">118.074659419021</span>, </span>
<span>                <span class="fl">49.5276240233455</span>, <span class="fl">49.5785159559446</span>, <span class="fl">49.6090511155041</span>, </span>
<span>                <span class="fl">49.6355149204556</span>, <span class="fl">49.6945495622705</span>, <span class="fl">49.6965852395745</span>,</span>
<span>                <span class="fl">49.7108349807022</span>, <span class="fl">49.7637625906053</span>, <span class="fl">49.780048009037</span>,</span>
<span>                <span class="fl">49.8614751011955</span><span class="op">)</span>, </span>
<span>              dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">2L</span><span class="op">)</span>, </span>
<span>              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"XY"</span>, <span class="st">"LINESTRING"</span>, <span class="st">"sfg"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    n_empty <span class="op">=</span> <span class="fl">0L</span>, class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sfc_LINESTRING"</span>, <span class="st">"sfc"</span><span class="op">)</span>,</span>
<span>    precision <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    bbox <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">118.115940805193</span>, </span>
<span>                       ymin <span class="op">=</span> <span class="fl">49.5276240233455</span>, </span>
<span>                       xmax <span class="op">=</span> <span class="op">-</span><span class="fl">118.074659419021</span>, </span>
<span>                       ymax <span class="op">=</span> <span class="fl">49.8614751011955</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"bbox"</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>input <span class="op">=</span> <span class="cn">NA_character_</span>, wkt <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>                    class <span class="op">=</span> <span class="st">"crs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  row.names <span class="op">=</span> <span class="fl">1L</span>, sf_column <span class="op">=</span> <span class="st">"geometry"</span>,</span>
<span>  agr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"factor"</span>, </span>
<span>                  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"constant"</span>, <span class="st">"aggregate"</span>,<span class="st">"identity"</span><span class="op">)</span>, </span>
<span>                  names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sf"</span>, <span class="st">"data.frame"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">lnds</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we are ready to project the locations of roads connecting each
landing to our initial road network.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rd_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projectRoads.html">projectRoads</a></span><span class="op">(</span><span class="va">lnds</span>, <span class="va">wt_rast</span>, <span class="va">rd_in</span>, weightFunction <span class="op">=</span> <span class="va">gradePenaltyFn</span>, </span>
<span>                        roadsInWeight <span class="op">=</span> <span class="cn">FALSE</span>, roadMethod <span class="op">=</span> <span class="st">"ilcp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Burning in roads to weightRaster from sf</span></span></code></pre></div>
<p>Our first attempt results in an error because one or more landings
cannot be reached without traversing a grade of more than 20% which is
the default value of <code>limit</code> in
<code><a href="../reference/gradePenaltyFn.html">gradePenaltyFn()</a></code>. To avoid this we can increase
<code>limit</code> or change <code>limitWeight</code> to something other
than <code>NA</code>. Below we try both setting <code>limit = 30</code>
and <code>limitWeight = 40000^2</code>. Which have slightly different
results.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rd_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projectRoads.html">projectRoads</a></span><span class="op">(</span><span class="va">lnds</span>, <span class="va">wt_rast</span>, <span class="va">rd_in</span>, weightFunction <span class="op">=</span> <span class="va">gradePenaltyFn</span>, </span>
<span>                        roadsInWeight <span class="op">=</span> <span class="cn">FALSE</span>, roadMethod <span class="op">=</span> <span class="st">"ilcp"</span>, limit <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="co">#&gt; Burning in roads to weightRaster from sf</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plotRoads.html">plotRoads</a></span><span class="op">(</span><span class="va">rd_proj</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/proj-rds-1.png" class="r-plt" alt="" width="624"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">rd_proj3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projectRoads.html">projectRoads</a></span><span class="op">(</span><span class="va">lnds</span>, <span class="va">wt_rast</span>, <span class="va">rd_in</span>, weightFunction <span class="op">=</span> <span class="va">gradePenaltyFn</span>, </span>
<span>                        roadsInWeight <span class="op">=</span> <span class="cn">FALSE</span>, roadMethod <span class="op">=</span> <span class="st">"ilcp"</span>, limitWeight <span class="op">=</span> <span class="fl">40000</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Burning in roads to weightRaster from sf</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plotRoads.html">plotRoads</a></span><span class="op">(</span><span class="va">rd_proj3</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/proj-rds-2.png" class="r-plt" alt="" width="624"></p>
<p>Another challenge can occur if an area is not accessible without
crossing cells that are <code>NA</code>. Below we set all areas with
greater than 10% water to <code>NA</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set &gt; 10% water to NA </span></span>
<span><span class="va">wat_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="va">dem_example</span><span class="op">$</span><span class="va">ex_wat</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wt_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">wt_rast</span>, <span class="va">wat_10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wt_rast</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">6.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="624"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/projectRoads.html">projectRoads</a></span><span class="op">(</span><span class="va">lnds</span>, <span class="va">wt_rast</span>, <span class="va">rd_in</span>, weightFunction <span class="op">=</span> <span class="va">gradePenaltyFn</span>,</span>
<span>             roadsInWeight <span class="op">=</span> <span class="cn">FALSE</span>, roadMethod <span class="op">=</span> <span class="st">"ilcp"</span>, limit <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="co">#&gt; Burning in roads to weightRaster from sf</span></span>
<span><span class="co">#&gt; Warning in igraph::shortest_paths(sim$g, path.list[1], path.list[2], out =</span></span>
<span><span class="co">#&gt; "both"): At vendor/cigraph/src/paths/dijkstra.c:534 : Couldn't reach some</span></span>
<span><span class="co">#&gt; vertices.</span></span>
<span><span class="co">#&gt; Warning in igraph::shortest_paths(sim$g, path.list[1], path.list[2], out =</span></span>
<span><span class="co">#&gt; "both"): At vendor/cigraph/src/paths/dijkstra.c:534 : Couldn't reach some</span></span>
<span><span class="co">#&gt; vertices.</span></span>
<span><span class="co">#&gt; Warning in igraph::shortest_paths(sim$g, path.list[1], path.list[2], out =</span></span>
<span><span class="co">#&gt; "both"): At vendor/cigraph/src/paths/dijkstra.c:534 : Couldn't reach some</span></span>
<span><span class="co">#&gt; vertices.</span></span>
<span><span class="co">#&gt; Warning in igraph::shortest_paths(sim$g, path.list[1], path.list[2], out =</span></span>
<span><span class="co">#&gt; "both"): At vendor/cigraph/src/paths/dijkstra.c:534 : Couldn't reach some</span></span>
<span><span class="co">#&gt; vertices.</span></span>
<span><span class="co">#&gt; Warning in igraph::shortest_paths(sim$g, path.list[1], path.list[2], out =</span></span>
<span><span class="co">#&gt; "both"): At vendor/cigraph/src/paths/dijkstra.c:534 : Couldn't reach some</span></span>
<span><span class="co">#&gt; vertices.</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> NA values in weightRaster along paths. Check for disconnected clumps in weightRaster. If weightFunction=gradePenaltyFn, try adjusting limit or setting limitWeight to high value that is not NA.</span></span></code></pre></div>
<p>To address this we can change <code>NA</code> values to an
arbitrarily large negative value to prevent crossing unless
required.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wt_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subst.html" class="external-link">subst</a></span><span class="op">(</span><span class="va">wt_rast</span>, from <span class="op">=</span> <span class="cn">NA</span>, to <span class="op">=</span> <span class="op">-</span><span class="fl">40000</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rd_proj2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projectRoads.html">projectRoads</a></span><span class="op">(</span><span class="va">lnds</span>, <span class="va">wt_rast</span>, <span class="va">rd_in</span>, weightFunction <span class="op">=</span> <span class="va">gradePenaltyFn</span>,</span>
<span>             roadsInWeight <span class="op">=</span> <span class="cn">FALSE</span>, roadMethod <span class="op">=</span> <span class="st">"ilcp"</span>, limit <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="co">#&gt; Burning in roads to weightRaster from sf</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/plotRoads.html">plotRoads</a></span><span class="op">(</span><span class="va">rd_proj2</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40000</span><span class="op">^</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">40000</span>, <span class="op">-</span><span class="fl">30000</span>, <span class="op">-</span><span class="fl">20000</span>, <span class="op">-</span><span class="fl">16178</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">*</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"blues"</span>, <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"oranges"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     colNA <span class="op">=</span> <span class="st">"grey50"</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">8.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="grade-penalty_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="" width="624"></p>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Anderson AE, Nelson J (2004) Projecting vector-based road networks
with a shortest path algorithm. Canadian Journal of Forest Research
34:1444–1457. <a href="https://doi.org/10.1139/x04-030" class="external-link uri">https://doi.org/10.1139/x04-030</a></p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Endicott, Kyle Lochhead, Josie Hughes, Patrick Kirby.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
